<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>BistrackPi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    .bg-primary, .btn-primary, .table-primary {
            background-color: #053c55ff !important;
        }
    .image-container {
        position: relative;
        display: block; /* or inline-block or block, depending on desired layout */
    }

    .image-text {
        position: absolute;
        top: 50%;
        left: 235px;
        transform: translate(-50%, -50%);
        text-align: center;
        width: 100%; /* Ensure text spans the image width */
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</head>
<body>
  <div class="container">
    <div class="image-container bg-primary text-white p-2">
      <img src="images/bistrackPi.png" alt="BistrackPi Logo" class="img-fluid">
      <div class="image-text">
        <h1>BisTrackPi</h1>
      </div>
    </div>
    <h2 class="mt-3">Expected Trucks</h2>
    <div class="row">
      <div class="col-md-12">
        <table id="mainTable" class="table table-bordered table-striped table-hover">
        </table>
        <script>
            /* -----------------------------------------------------------------
               Function to check if the passed string is a date (not datetime)
               and if so, format it to MM/DD/YYYY, otherwise, return the passed string.
            ----------------------------------------------------------------- */
            function ifDateFormat(dateString) {
                const date = new Date(dateString);

                if (isNaN(date.getTime())) {
                    // Not a valid date. Return the passed string.
                    return dateString;
                }

                const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const day = String(date.getDate()).padStart(2, '0');
                const year = date.getFullYear();

                return `${month}/${day}/${year}`;
            }

            /* -----------------------------------------------------------------
                Function to format column data. If the value is null, undefined, or "null", return an empty string.
                If the value is a date format, format it to MM/DD/YYYY.
                Otherwise, return the value as is.
            -----------------------------------------------------------------*/
            function formatColData(value) {
                if (value === null || value === undefined || value === "null") {
                    return "";
                } else if (typeof value === "number" || typeof value === "boolean" || typeof value === "bigint") {
                    // Check for numbers such as PO numbers before checking for dates as some numbers can be converted to dates
                    return value;
                } else if ((/Z/.test(value)) && (/:/.test(value))) {
                    return ifDateFormat(value);
                } else {
                    return value;
                }
            }

           /* -----------------------------------------------------------------
                Function to convert a GMT date/time string to a locale date string.
                If the date is invalid, return the original string.
            -----------------------------------------------------------------*/
            function convertGMTToLocale(dateString) {
                const date = new Date(dateString);
                const retVal = isNaN(date) ? dateString : date.toLocaleString();
                return retVal;
            }

            /* -----------------------------------------------------------------
                Function to refresh the data in the passed table using JSON data
                from the specified file path. Cols are dynamically generated.
                constructs the table headers and rows, and appends them to the table object.
            -----------------------------------------------------------------*/
            function rebuildTable(filePath, tableObj) {
                $.getJSON(filePath,
                    function (data) {
                        let tableHTML = "";
                        // Loop through the array of objects
                        $.each(data, function (i, obj) {
                            // First time through, create the header using the object's keys
                            if(i === 0) {
                                tableHTML += '<thead class="table-primary text-white"><tr>';
                                // Loop through each key in the object
                                $.each(obj, function (key, value) {
                                    tableHTML += "<th>" + key + "</th>";
                                });
                                tableHTML += "</tr></thead><tbody>";
                            }
                            tableHTML += "<tr>";
                            $.each(obj, function (key, value) {
                                tableHTML += "<td>" + formatColData(value) + "</td>";
                            });
                            tableHTML += "</tr>";
                        });
                        tableHTML += "</tbody>";
                        tableObj.append(tableHTML);
                        // Check if we have a last modified date in session storage
                        if (sessionStorage.getItem("caption")) {
                            // If we have a last modified date, prepend it to the table as a caption
                            mTable.prepend($("<caption></caption>").text(sessionStorage.getItem("caption")));
                        }
                }).fail(function(xhr, textstatus, error) {
                    if (xhr.status === 404) {
                        // If the data file is missing, try to recreate the file one time. If it fails, display an error message on subsequent reloads
                        if((sessionStorage.getItem("reloadCntr")) && (sessionStorage.getItem("reloadCntr") === "1")) {
                            submitForm();
                        } else {
                            displayError(tableObj, `Missing data file and unable to recreate (check server logs): ${filePath}. ${textstatus} : ${error}`)
                        }
                    } else {
                        displayError(tableObj, `Unknown error attempting to access JSON: ${filePath}. ${textstatus} : ${error}`);
                    }
                });
            }

            /* -----------------------------------------------------------------
                Function to display errors as a single row in the passed table object.
            -----------------------------------------------------------------*/
            function displayError(tableObj, errorMsg) {
                console.log(errorMsg);
                tableObj.html('<tr class="table-danger"><td class="table-danger">' + errorMsg + "</td></tr>");
                tableObj.removeClass("table-striped table-hover");
                tableObj.addClass("table-danger");
            }

            /* -----------------------------------------------------------------
                Function to submit the form and refresh the page. Intended to be called from an Interval
            -----------------------------------------------------------------*/
            function submitForm() {
                $("#refreshForm").submit();
            }

            // TODO: This functionality doesn't really work; was not able to increment the counter and persist following multiple reloads
            function incrementReloadCntr() {
                const cntrName = "reloadCntr";
                if(sessionStorage.getItem(cntrName)) {
                    const val = parseInt(sessionStorage.getItem(cntrName)) + 1;
                    sessionStorage.setItem(cntrName, val.toString());
                    console.log(`Incrementing reload counter: ${val}`);
                }
                sessionStorage.setItem(cntrName, "1");
            }

            const mTable = $("#mainTable");
            // The page will reload and refresh the data every pageRefreshSeconds
            const pageRefreshSeconds = 1000;

            // Handle form submission when the "Refresh" button is clicked
            $(document).ready(function () {
                // Setup the reload counter and set to 1 for initial load; increment for each reload
                incrementReloadCntr();
                console.log("Reload counter: " + sessionStorage.getItem("reloadCntr"));

                // Check session storage for the intervalID; if found, clear and recreate (reload destroys the interval)
                if(sessionStorage.getItem("intervalID")) {
                    clearInterval(sessionStorage.getItem("intervalID"));
                }
                // Automatically refresh the data by resubmitting the form and calling /data every pageRefreshSeconds
                const intvID = setInterval(submitForm, (pageRefreshSeconds * 1000));
                // Store the ID in session storage so we can clear it if the page is reloaded
                sessionStorage.setItem("intervalID", intvID);

                // Capture the form submission
                $('#refreshForm').on('submit', function(event) {
                    // Disable the button to prevent multiple submissions
                    $("#formSubmit").addClass("disabled").prop("disabled", true);
                    // Prevent the default form submission and subsequent reload to introduce a pause
                    event.preventDefault();
                    // Submit the form using AJAX; (the /data route writes JSON data to a file)
                    $.ajax({
                        method: "POST",
                        url: "/data",
                    }).done(function(msg, textStatus, req) {
                        // Update the table's caption with the last modified date as returned in the last-modified header (see server /data route)
                        const captionTxt = "Last updated on: " + convertGMTToLocale(req.getResponseHeader("Last-Modified"));
                        sessionStorage.setItem("caption", captionTxt)
                        // Give the query time to execute and return data in a JSON file. Then reload
                        // TODO: Call progress modal here?
                        const queryExecTime = 3;
                        setTimeout(() => location.reload(), 1000 * queryExecTime);
                    }).fail(function(xhr, textstatus, error) {
                        console.log(xhr);
                        displayError(mTable, `Error refreshing page (check server logs): ${xhr.status} ${textstatus} ${error}</BR>${xhr.responseText}`);
                    });
                });

                // Create the table with the JSON data created by the call to /data
                // Note, when the page is initially loaded, it will used the existing datafile and the table won't have a caption as the last-modified header hasn't been captured
                rebuildTable("/data/truckroute.json", mTable);
            });
        </script>
      </div>
      <div class="row">
        <div>
            <!-- This form exists primarily to support the "Refresh" button click but is also used to reload data on page reload -->
          <form id="refreshForm">
            <button id="formSubmit" type="submit" class="btn btn-primary float-end">Refresh</button>
          </form>
        </div>
      </div>
  </div>
</body>
</html>